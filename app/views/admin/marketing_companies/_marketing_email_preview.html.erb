<%
  preview_contact =
    company.marketing_contacts.first

  draft_email = company.marketing_emails.where(status: 'draft').first_or_initialize
  ai_generated_intro = draft_email.ai_generated_intro

  email = PromotionalMailer.cold_email_outreach(preview_contact, ai_generated_intro: ai_generated_intro)
  html_body = email.html_part ? email.html_part.body.to_s : email.body.to_s
  email_subject = "Unlock 22% Revenue Growth from #{company.name&.downcase&.split&.map(&:titleize)&.join(" ")} Reviews - Free Report Inside"

  draft_email.body = html_body
  draft_email.subject = email_subject
  draft_email.marketing_contact = preview_contact
  draft_email.save
%>

<p>Total Emails Sent: <%= company.marketing_emails.where(status: 'sent').count %></p>
<% if company.marketing_contacts.any? %>

  <div style="margin-bottom: 20px; display: flex; gap: 10px;">
    <%= button_to "Send Email", send_marketing_email_admin_marketing_company_path(company), method: :post, style: "background: #10b981; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;"%>
    <%= button_to "Generate with AI", generate_ai_email_admin_marketing_company_path(company), method: :post, style: "background: #6366f1; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;" %>
  </div>
<% else %>
  <p style="color: #ef4444;">No marketing contacts found for this company. Please add a marketing contact first.</p>
<% end %>

<div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; margin-top: 20px;">
  <div style="padding: 12px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
    <strong>Subject: <%= email_subject %></strong>
  </div>
  <br/>

  <div style="padding: 0;">
    <%= raw html_body %>
  </div>
</div>
