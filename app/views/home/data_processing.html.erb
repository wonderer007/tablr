<% content_for(:title, "Setting Up Your Dashboard - Tablr") %>

<div class="min-h-screen relative overflow-hidden">
  <!-- Background Effects -->
  <div class="absolute inset-0 mesh-gradient"></div>
  <div class="absolute top-20 left-10 w-72 h-72 bg-indigo-400/20 rounded-full blur-3xl animate-pulse-slow"></div>
  <div class="absolute bottom-20 right-10 w-96 h-96 bg-violet-400/20 rounded-full blur-3xl animate-pulse-slow" style="animation-delay: 2s;"></div>
  <div class="absolute top-1/2 left-1/3 w-80 h-80 bg-purple-400/10 rounded-full blur-3xl"></div>

  <div class="relative min-h-screen flex flex-col justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-lg mx-auto w-full">
      <% if @business.status.to_sym == :failed %>
        <!-- Failed State -->
        <div class="text-center mb-8">
          <div class="w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-red-400 to-rose-500 flex items-center justify-center shadow-xl shadow-red-500/30 mb-6">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </div>
          <h1 class="font-display text-3xl sm:text-4xl font-bold text-slate-900 tracking-tight mb-4">
            Something went wrong
          </h1>
          <p class="text-slate-600 text-lg mb-8">
            We encountered an issue while processing your data. Please try again or contact our support team.
          </p>
          <button onclick="window.location.reload()" 
                  class="inline-flex items-center justify-center gap-2 py-3 px-8 text-base font-semibold text-white bg-gradient-to-r from-indigo-600 to-violet-500 rounded-xl hover:shadow-lg hover:shadow-indigo-500/25 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-300">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Try Again
          </button>
        </div>
      <% else %>
        <!-- Processing State -->
        <div class="text-center mb-8">
          <!-- Animated Icon -->
          <div class="w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center shadow-xl shadow-indigo-500/30 mb-6">
            <svg class="w-10 h-10 text-white animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </div>
          <h1 class="font-display text-3xl sm:text-4xl font-bold text-slate-900 tracking-tight mb-4">
          Setting Up Your Dashboard
          </h1>
          <p class="text-slate-600 text-lg">
          <% case @business.status.to_sym %>
          <% when :created, :syncing_place %>
              Gathering information about your business...
            <% when :synced_place, :syncing_reviews %>
              Collecting your customer reviews...
            <% when :synced_reviews %>
              AI is analyzing your reviews for insights...
            <% else %>
              Processing your data...
            <% end %>
          </p>
        </div>

        <!-- Progress Card -->
        <div class="bg-white rounded-2xl shadow-xl shadow-slate-900/5 border border-slate-100 p-6 mb-6">
          <!-- Progress Steps -->
          <div class="space-y-4">
            <!-- Step 1: Restaurant Info -->
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 <%= @business.status.in?(['created', 'syncing_place']) ? 'bg-indigo-100' : 'bg-green-100' %>">
                <% if @business.status.in?(['created', 'syncing_place']) %>
                  <svg class="w-5 h-5 text-indigo-600 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                <% else %>
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                  </svg>
                <% end %>
              </div>
              <div class="flex-1">
                <div class="font-semibold text-slate-900">Gathering business information</div>
                <div class="text-sm text-slate-500">
                  <% if @business.status.in?(['created', 'syncing_place']) %>
                    In progress...
                  <% else %>
                    Completed
                  <% end %>
                </div>
              </div>
            </div>

            <!-- Step 2: Reviews -->
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 
                <%= if @business.status.in?(['synced_place', 'syncing_reviews'])
                      'bg-indigo-100'
                    elsif @business.status == 'synced_reviews'
                      'bg-green-100'
                    else
                      'bg-slate-100'
                    end %>">
                <% if @business.status.in?(['synced_place', 'syncing_reviews']) %>
                  <svg class="w-5 h-5 text-indigo-600 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                <% elsif @business.status == 'synced_reviews' %>
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                  </svg>
                <% else %>
                  <div class="w-2 h-2 rounded-full bg-slate-300"></div>
                <% end %>
              </div>
              <div class="flex-1">
                <div class="font-semibold <%= @business.status.in?(['created', 'syncing_place']) ? 'text-slate-400' : 'text-slate-900' %>">Collecting customer reviews</div>
                <div class="text-sm text-slate-500">
                  <% if @business.status.in?(['synced_place', 'syncing_reviews']) %>
                    In progress...
                  <% elsif @business.status == 'synced_reviews' %>
                    Completed
                  <% else %>
                    Waiting...
                  <% end %>
            </div>
            </div>
            </div>

            <!-- Step 3: AI Analysis -->
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 
                <%= @business.status == 'synced_reviews' ? 'bg-indigo-100' : 'bg-slate-100' %>">
                <% if @business.status == 'synced_reviews' %>
                  <svg class="w-5 h-5 text-indigo-600 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
          <% else %>
                  <div class="w-2 h-2 rounded-full bg-slate-300"></div>
                <% end %>
            </div>
              <div class="flex-1">
                <div class="font-semibold <%= @business.status != 'synced_reviews' ? 'text-slate-400' : 'text-slate-900' %>">AI analysis for insights</div>
                <div class="text-sm text-slate-500">
                  <% if @business.status == 'synced_reviews' %>
                    In progress...
                  <% else %>
                    Waiting...
          <% end %>
        </div>
              </div>
            </div>
          </div>

          <!-- Progress Bar -->
          <div class="mt-6 pt-6 border-t border-slate-100">
            <div class="flex items-center justify-between text-sm mb-2">
              <span class="font-medium text-slate-700">Overall Progress</span>
              <span class="text-slate-500">
                <% progress = case @business.status.to_sym
                   when :created, :syncing_place then 25
                   when :synced_place, :syncing_reviews then 50
                   when :synced_reviews then 75
                   else 10
                   end %>
                <%= progress %>%
              </span>
            </div>
            <div class="w-full bg-slate-100 rounded-full h-2">
              <div class="bg-gradient-to-r from-indigo-500 to-violet-500 h-2 rounded-full transition-all duration-500" style="width: <%= progress %>%"></div>
            </div>
          </div>
        </div>

        <!-- Status Info Card -->
        <div class="bg-white/60 backdrop-blur-sm rounded-xl border border-slate-200/60 p-4 text-center">
          <p class="text-sm text-slate-600 mb-2">
            This usually takes 2-5 minutes depending on the number of reviews.
          </p>
          <p class="text-sm text-slate-500">
            You'll be redirected automatically when ready.
          </p>
          <div class="mt-3 inline-flex items-center gap-2 text-sm font-medium text-indigo-600">
            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>Checking status in <span id="countdown">15</span>s</span>
          </div>
        </div>

        <!-- What You'll Get Preview -->
        <div class="mt-8 pt-8 border-t border-slate-200/50">
          <p class="text-sm font-medium text-slate-500 text-center mb-6">What you'll get</p>
          <div class="grid grid-cols-3 gap-4">
            <div class="text-center">
              <div class="w-12 h-12 mx-auto rounded-xl bg-red-50 flex items-center justify-center mb-3 shadow-sm">
                <svg class="w-6 h-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 0 1 .865-.501 48.172 48.172 0 0 0 3.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018Z" />
                </svg>
              </div>
              <p class="text-sm font-medium text-slate-700">Complaints</p>
              <p class="text-xs text-slate-500 mt-1">Issues to address</p>
            </div>
            <div class="text-center">
              <div class="w-12 h-12 mx-auto rounded-xl bg-amber-50 flex items-center justify-center mb-3 shadow-sm">
                <svg class="w-6 h-6 text-amber-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" />
                </svg>
              </div>
              <p class="text-sm font-medium text-slate-700">Suggestions</p>
              <p class="text-xs text-slate-500 mt-1">Ideas to improve</p>
            </div>
            <div class="text-center">
              <div class="w-12 h-12 mx-auto rounded-xl bg-indigo-50 flex items-center justify-center mb-3 shadow-sm">
                <svg class="w-6 h-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                </svg>
              </div>
              <p class="text-sm font-medium text-slate-700">Analytics</p>
              <p class="text-xs text-slate-500 mt-1">Deep insights</p>
            </div>
          </div>
          </div>
        <% end %>
    </div>
  </div>
</div>

<% unless @business.status.to_sym == :failed %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    let timeLeft = 15;
    const countdownElement = document.getElementById('countdown');
    
    function checkProcessingStatus() {
      fetch('<%= data_processing_path %>', {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (response.redirected) {
          // If the server responds with a redirect, follow it
          window.location.href = response.url;
        } else {
          return response.json().then(data => {
            // Check if first_inference_completed is true
            if (data.first_inference_completed) {
              window.location.href = '<%= dashboard_path %>';
        } else {
          // Reset countdown and check again
          timeLeft = 15;
          startCountdown();
              // Reload to get updated status display
              window.location.reload();
            }
          });
        }
      })
      .catch(error => {
        console.log('Status check error:', error);
        // On error, just reload the page to refresh status
        timeLeft = 15;
        startCountdown();
      });
    }
    
    function startCountdown() {
      const countdown = setInterval(function() {
        timeLeft--;
        if (countdownElement) {
        countdownElement.textContent = timeLeft;
        }
        
        if (timeLeft <= 0) {
          clearInterval(countdown);
          checkProcessingStatus();
        }
      }, 1000);
    }
    
    // Start the countdown
    startCountdown();
  });
</script>
<% end %>
