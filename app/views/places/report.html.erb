<% content_for :title, "#{@place.name} Restaurant Review Insights Report | Tablr.io" %>
<% content_for :description, "Sentiment trends, guest highlights, and action-ready opportunities for #{@place.name} powered by Tablr.io." %>

<%
address = @place.address.presence
positive_percentage = @sentiment_stats[:positive_percentage]
neutral_percentage = @sentiment_stats[:neutral_percentage]
negative_percentage = @sentiment_stats[:negative_percentage]
positive_total = @sentiment_stats[:positive]
neutral_total = @sentiment_stats[:neutral]
negative_total = @sentiment_stats[:negative]

positive_keywords = Array(@top_positive_keywords)
negative_keywords = Array(@top_negative_keywords)
dish_keywords = Array(@top_dishes)
keyword_categories = Array(@keywords_by_category)

share_url = request.original_url
share_url_js = j(share_url)

sentiment_blurb =
  if positive_percentage.to_f >= 75 && negative_percentage.to_f <= 10
    "Guests are delighted overall—keep reinforcing the moments they already love while smoothing over small friction points."
  elsif negative_percentage.to_f >= 20
    "Guests see promise, but recurring frustrations are slowing momentum—prioritize the fixes below to protect loyalty."
  else
    "Guests respond positively overall, with clear opportunities to tighten consistency and exceed expectations."
  end

positive_theme_words = positive_keywords.first(3).map { |keyword| keyword[:name].to_s.titleize }.reject(&:blank?)
positive_theme_sentence =
  if positive_theme_words.any?
    "Guests mention #{positive_theme_words.to_sentence(two_words_connector: ' and ', last_word_connector: ', and ')} most often."
  else
    "Guests frequently call out the warm hospitality and overall vibe."
  end

opportunity_theme_words = negative_keywords.first(3).map { |keyword| keyword[:name].to_s.titleize }.reject(&:blank?)
opportunity_theme_sentence =
  if opportunity_theme_words.any?
    "Watch recurring mentions of #{opportunity_theme_words.to_sentence(two_words_connector: ' and ', last_word_connector: ', and ')}."
  else
    "Keep monitoring reviews for emerging friction points—recent feedback looks steady."
  end

food_mentions = (dish_keywords.presence || positive_keywords).first(2).to_a.map { |keyword| keyword[:name].to_s.titleize }.reject(&:blank?)
service_mentions = negative_keywords.first(2).map { |keyword| keyword[:name].to_s.titleize }.reject(&:blank?)

ambiance_category = keyword_categories.find { |category| category[:name].to_s.parameterize == 'ambiance' }
ambiance_keywords = Array(ambiance_category&.dig(:positives)).first(2).map { |keyword| keyword[:name].to_s.titleize }.reject(&:blank?)

experience_cards = [
  {
    title: 'Overall Experience',
    score: @rating_breakdown[:overall],
    description: positive_theme_sentence
  },
  {
    title: 'Food',
    score: @rating_breakdown[:food],
    description: food_mentions.any? ? "Food stands out for #{food_mentions.to_sentence(two_words_connector: ' and ', last_word_connector: ', and ')}." : 'Showcase signature dishes to keep guests talking.'
  },
  {
    title: 'Service',
    score: @rating_breakdown[:service],
    description: service_mentions.any? ? "Guests need smoother moments around #{service_mentions.to_sentence(two_words_connector: ' and ', last_word_connector: ', and ')}." : 'Deliver proactive table touches to stay ahead of guest expectations.'
  },
  {
    title: 'Ambiance',
    score: @rating_breakdown[:atmosphere],
    description: ambiance_keywords.any? ? "People love the #{ambiance_keywords.to_sentence(two_words_connector: ' and ', last_word_connector: ', and ')} vibe." : 'Lean into lighting, music, and pacing to keep energy high.'
  },
  {
    title: 'Cleanliness',
    score: nil,
    description: 'Unlock full Tablr access to benchmark cleanliness perceptions across every review.'
  },
  {
    title: 'Value for Money',
    score: nil,
    description: 'Upgrade to see how guests rate price-to-experience versus competitors.'
  }
]

complaint_categories = Array(@complaint_summary[:categories]).first(4)
suggestion_categories = Array(@suggestion_summary[:categories]).first(4)
complaint_topics = Array(@complaint_summary[:top]).first(4)
suggestion_topics = Array(@suggestion_summary[:top]).first(4)

def improvement_prompt(topic)
  return 'Use pre-shift briefs to align the team on this focus area.' if topic.blank?

  case topic.to_s.downcase
  when /service/, /staff/, /wait/, /speed/
    'Coach the floor team on greeting speed and table check-ins this week.'
  when /food/, /dish/, /meal/, /quality/
    'Review prep standards with BOH and spotlight the winning dishes at line-up.'
  when /clean/, /bathroom/, /hygiene/
    'Tighten cleaning walkthroughs during peak hours and log results.'
  when /price/, /value/, /expensive/
    'Revisit menu positioning and pair high-value items with upsell scripts.'
  else
    'Assign an owner to investigate and report back with a quick win by Friday.'
  end
end
%>

<main class="bg-slate-50 text-slate-900">
  <section class="relative overflow-hidden">
    <div class="absolute inset-0">
      <div class="absolute inset-0 bg-gradient-to-br from-white via-sky-50 to-indigo-100"></div>
      <div class="absolute -top-24 -right-32 h-80 w-80 rounded-full bg-indigo-300/30 blur-3xl"></div>
      <div class="absolute -bottom-24 -left-24 h-64 w-64 rounded-full bg-sky-200/40 blur-3xl"></div>
    </div>

    <div class="relative mx-auto max-w-5xl px-6 pb-20 pt-20 text-slate-900">
      <p class="text-xs font-semibold uppercase tracking-[0.35em] text-indigo-400">Tablr.io Restaurant Review Insights Report</p>
      <h1 class="mt-4 text-4xl font-semibold leading-tight sm:text-5xl">
        <%= @place.name %>
      </h1>
      <% if address.present? %>
        <p class="mt-2 text-sm text-slate-500"><%= address %></p>
      <% end %>
      <p class="mt-6 max-w-3xl text-lg text-slate-600">
        Tablr.io analyzed 100 recent public Google reviews to map how guests feel about your restaurant right now. Below is a curated snapshot of the wins to amplify and the fixes to tackle next.
      </p>

      <div class="mt-8 flex flex-wrap items-center gap-4 text-sm text-slate-600">
        <div class="flex items-center gap-2 rounded-full bg-white px-4 py-2 shadow-sm shadow-indigo-100">
          <span class="text-indigo-500 font-semibold"><%= number_with_delimiter(@total_reviews) %></span>
          <span>reviews analyzed</span>
        </div>
        <div class="flex items-center gap-2 rounded-full bg-white px-4 py-2 shadow-sm shadow-indigo-100">
          <span class="text-indigo-500 font-semibold"><%= number_with_precision(@average_rating, precision: 1) %></span>
          <span>average rating</span>
        </div>
        <span class="text-xs uppercase tracking-wide text-slate-400">Updated <%= @report_generated_at.strftime('%b %d, %Y %l:%M %p %Z') %></span>
      </div>
    </div>
  </section>

  <section class="mx-auto mt-12 max-w-5xl px-6">
    <div class="rounded-3xl bg-white p-8 shadow-xl shadow-slate-200/70">
      <div class="flex flex-col gap-6 md:flex-row md:items-center md:justify-between">
        <div>
          <h2 class="text-xl font-semibold text-slate-900">Sentiment Snapshot</h2>
          <p class="mt-2 text-sm text-slate-500">Overall guest sentiment sits at <span class="font-semibold text-slate-900"><%= number_to_percentage(positive_percentage, precision: 1) %> positive</span>, <span class="font-semibold text-slate-900"><%= number_to_percentage(neutral_percentage, precision: 1) %> neutral</span>, and <span class="font-semibold text-slate-900"><%= number_to_percentage(negative_percentage, precision: 1) %> negative</span>.</p>
          <p class="mt-4 text-sm text-slate-600"><%= sentiment_blurb %></p>
        </div>
        <div class="grid gap-3 sm:grid-cols-3">
          <div class="rounded-2xl border border-emerald-100 bg-emerald-50 p-4 text-center">
            <p class="text-xs font-semibold uppercase tracking-wide text-emerald-500">Positive</p>
            <p class="mt-2 text-2xl font-semibold text-emerald-600"><%= number_with_delimiter(positive_total) %></p>
            <p class="text-xs text-emerald-500/80"><%= positive_total == 1 ? 'Positive review' : 'Positive reviews' %></p>
          </div>
          <div class="rounded-2xl border border-amber-100 bg-amber-50 p-4 text-center">
            <p class="text-xs font-semibold uppercase tracking-wide text-amber-500">Neutral</p>
            <p class="mt-2 text-2xl font-semibold text-amber-600"><%= number_with_delimiter(neutral_total) %></p>
            <p class="text-xs text-amber-500/80"><%= neutral_total == 1 ? 'Neutral review' : 'Neutral reviews' %></p>
      </div>
          <div class="rounded-2xl border border-rose-100 bg-rose-50 p-4 text-center">
            <p class="text-xs font-semibold uppercase tracking-wide text-rose-500">Negative</p>
            <p class="mt-2 text-2xl font-semibold text-rose-600"><%= number_with_delimiter(negative_total) %></p>
            <p class="text-xs text-rose-500/80"><%= negative_total == 1 ? 'Negative review' : 'Negative reviews' %></p>
      </div>
        </div>
      </div>
      <p class="mt-6 rounded-2xl bg-slate-50 p-4 text-sm text-slate-600">
        <span class="font-semibold text-slate-900">Tablr takeaway:</span> <%= opportunity_theme_sentence %>
      </p>
    </div>
  </section>

  <section class="mx-auto mt-12 max-w-5xl px-6">
      <div class="rounded-3xl bg-white p-8 shadow-xl shadow-slate-200/70">
      <h2 class="text-xl font-semibold text-slate-900">Experience Scores</h2>
      <p class="mt-2 text-sm text-slate-500">Each score reflects the latest guest commentary scored on a 5-point scale.</p>
      <div class="mt-6 grid gap-4 md:grid-cols-2">
        <% experience_cards.each do |card| %>
          <div class="flex h-full flex-col justify-between rounded-2xl border border-slate-200 bg-slate-50 p-5">
            <div>
              <p class="text-sm font-medium text-slate-600"><%= card[:title] %></p>
              <div class="mt-3 flex items-baseline gap-2">
                <% if card[:score].present? %>
                  <span class="text-3xl font-semibold text-slate-900"><%= number_with_precision(card[:score], precision: 1) %></span>
                <span class="text-xs uppercase tracking-wide text-slate-500">/5</span>
                <% else %>
                  <%= link_to 'Unlock', '/users/sign_up', class: 'text-lg font-semibold text-indigo-500 hover:text-indigo-600' %>
                <% end %>
              </div>
            </div>
            <p class="mt-4 text-sm text-slate-600"><%= card[:description] %></p>
            </div>
          <% end %>
      </div>
    </div>
  </section>

  <section class="mx-auto mt-12 max-w-5xl px-6">
    <div class="grid gap-10 lg:grid-cols-2">
      <div class="rounded-3xl bg-emerald-50 p-8 shadow-xl">
        <h2 class="text-xl font-semibold text-emerald-700">What Guests Love</h2>
        <p class="mt-2 text-sm text-emerald-600">Lean into these strengths in your marketing, nightly lineups, and team recognition.</p>
        <% if positive_keywords.present? %>
          <ul class="mt-6 space-y-3">
            <% positive_keywords.first(5).each_with_index do |keyword, index| %>
              <% keyword_name = keyword[:name].to_s %>
              <li class="rounded-2xl bg-white px-4 py-3 text-sm text-emerald-700 shadow-sm">
                <div class="flex items-center justify-between">
                  <% if index < 3 && keyword_name.present? %>
                    <span class="font-semibold capitalize"><%= keyword_name.titleize %></span>
                  <% else %>
                    <%= link_to 'Unlock', '/users/sign_up', class: 'font-semibold text-indigo-500 hover:text-indigo-600' %>
                  <% end %>
                <span class="rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700"><%= keyword[:count] %> mentions</span>
                </div>
                <% if index < 3 && keyword_name.present? %>
                  <p class="mt-2 text-xs text-emerald-600/80">Your <%= keyword_name.downcase %> is winning hearts—spotlight it in social posts and table touches.</p>
                <% else %>
                  <p class="mt-2 text-xs text-emerald-600/80"><%= link_to 'Unlock full access', '/users/sign_up', class: 'text-indigo-500 underline decoration-indigo-200 hover:decoration-indigo-400' %> to surface the exact theme driving these mentions.</p>
                <% end %>
              </li>
            <% end %>
          </ul>
        <% else %>
          <p class="mt-6 text-sm text-emerald-600/70">Once new positive reviews arrive, your top applause-worthy themes will surface here automatically.</p>
        <% end %>
      </div>

      <div class="rounded-3xl bg-rose-50 p-8 shadow-xl">
        <h2 class="text-xl font-semibold text-rose-700">Opportunities to Fix</h2>
        <p class="mt-2 text-sm text-rose-600">Resolve these friction points quickly to protect ratings and repeat visits.</p>
        <% if complaint_topics.present? %>
          <ul class="mt-6 space-y-3">
            <% complaint_topics.each_with_index do |item, index| %>
              <% topic_text = item[:text].to_s %>
              <li class="rounded-2xl bg-white px-4 py-3 text-sm text-rose-700 shadow-sm">
                <div class="flex items-center justify-between">
                  <% if index < 3 && topic_text.present? %>
                    <span class="font-semibold capitalize"><%= topic_text %></span>
                  <% else %>
                    <%= link_to 'Unlock', '/users/sign_up', class: 'font-semibold text-indigo-500 hover:text-indigo-600' %>
                  <% end %>
                  <span class="rounded-full bg-rose-100 px-3 py-1 text-xs font-semibold text-rose-700"><%= item[:count] %> mentions</span>
                </div>
                <% if index < 3 && topic_text.present? %>
                  <p class="mt-2 text-xs text-rose-600/80">Several guests brought this up—circle back with the team and close the loop this week.</p>
                <% else %>
                  <p class="mt-2 text-xs text-rose-600/80"><%= link_to 'Unlock full Tablr access', '/users/sign_up', class: 'text-indigo-500 underline decoration-indigo-200 hover:decoration-indigo-400' %> to reveal the specific issue guests keep flagging.</p>
                <% end %>
              </li>
            <% end %>
          </ul>
        <% else %>
          <p class="mt-6 text-sm text-rose-600/70">No repeat issues at the moment—stay proactive by checking this section after each review sync.</p>
        <% end %>
      </div>
    </div>
  </section>

  <section class="mx-auto mt-12 max-w-5xl px-6">
    <div class="rounded-3xl bg-white p-8 shadow-xl shadow-slate-200/70">
      <h2 class="text-xl font-semibold text-slate-900">Complaints & Suggestions</h2>
      <p class="mt-2 text-sm text-slate-500">Translate guest critiques into clear action items for the next service window.</p>
      <div class="mt-8 grid gap-8 md:grid-cols-2">
        <div>
          <h3 class="text-xs font-semibold uppercase tracking-wide text-rose-500">Complaint Topics</h3>
          <% if complaint_categories.present? %>
            <ul class="mt-4 space-y-3">
              <% complaint_categories.each_with_index do |(topic, count), index| %>
                <li class="rounded-2xl border border-rose-100 bg-rose-50 px-4 py-4 text-sm text-rose-700 shadow-sm">
                  <div class="flex items-center justify-between">
                    <% if index < 3 && topic.present? %>
                      <span class="font-semibold"><%= topic.to_s.titleize %></span>
                    <% else %>
                      <%= link_to 'Unlock', '/users/sign_up', class: 'font-semibold text-indigo-500 hover:text-indigo-600' %>
                    <% end %>
                    <span class="rounded-full bg-white px-3 py-1 text-xs font-semibold text-rose-600"><%= count %> mentions</span>
                  </div>
                  <% if index < 3 && topic.present? %>
                    <p class="mt-2 text-xs text-rose-600/80"><%= improvement_prompt(topic) %></p>
                  <% else %>
                    <p class="mt-2 text-xs text-rose-600/80"><%= link_to 'Unlock full Tablr access', '/users/sign_up', class: 'text-indigo-500 underline decoration-indigo-200 hover:decoration-indigo-400' %> to reveal the exact issue fueling these mentions.</p>
                  <% end %>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="mt-4 text-sm text-slate-500">No complaint clusters detected—keep celebrating the wins above.</p>
          <% end %>
        </div>

        <div>
          <h3 class="text-xs font-semibold uppercase tracking-wide text-amber-500">Guest Suggestions</h3>
          <% if suggestion_topics.present? %>
            <ul class="mt-4 space-y-3">
              <% suggestion_topics.each_with_index do |item, index| %>
                <% suggestion_text = item[:text].to_s %>
                <li class="rounded-2xl border border-amber-100 bg-amber-50 px-4 py-4 text-sm text-amber-700 shadow-sm">
                  <div class="flex items-center justify-between">
                    <% if index < 3 && suggestion_text.present? %>
                      <span class="font-semibold"><%= suggestion_text.capitalize %></span>
                    <% else %>
                      <%= link_to 'Unlock', '/users/sign_up', class: 'font-semibold text-indigo-500 hover:text-indigo-600' %>
                    <% end %>
                    <span class="rounded-full bg-white px-3 py-1 text-xs font-semibold text-amber-600"><%= item[:count] %> mentions</span>
                  </div>
                  <% if index < 3 && suggestion_text.present? %>
                    <p class="mt-2 text-xs text-amber-600/80">Turn this into a quick win—pilot the idea for a week and track guest reactions.</p>
                  <% else %>
                    <p class="mt-2 text-xs text-amber-600/80"><%= link_to 'Unlock the full report', '/users/sign_up', class: 'text-indigo-500 underline decoration-indigo-200 hover:decoration-indigo-400' %> to see the exact suggestion guests are asking for.</p>
                  <% end %>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="mt-4 text-sm text-slate-500">Guests haven’t shared specific suggestions yet—invite feedback at the host stand to spark ideas.</p>
          <% end %>
        </div>
      </div>

      <% if keyword_categories.any? %>
        <div class="mt-10">
          <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Themes by Category</h3>
          <div class="mt-4 grid gap-6 lg:grid-cols-2">
            <% keyword_categories.first(6).each_with_index do |category, index| %>
              <div class="rounded-2xl border border-slate-200 bg-slate-50 p-5">
                <div class="flex items-center justify-between">
                  <% if index < 3 && category[:name].present? %>
                    <p class="text-base font-semibold text-slate-900"><%= category[:name].to_s.titleize %></p>
                  <% else %>
                    <p class="text-base font-semibold text-indigo-500"><%= link_to 'Unlock', '/users/sign_up', class: 'text-indigo-500 hover:text-indigo-600 underline decoration-indigo-200 hover:decoration-indigo-400' %></p>
                  <% end %>
                  <span class="rounded-full bg-indigo-100 px-3 py-1 text-xs font-semibold text-indigo-700"><%= category[:total] %> mentions</span>
                </div>
                <% if index < 3 %>
                <% if category[:positives].present? %>
                    <p class="mt-4 text-xs font-semibold uppercase tracking-wide text-emerald-500">Delighting guests</p>
                  <div class="mt-2 flex flex-wrap gap-2">
                      <% category[:positives].first(3).each do |keyword| %>
                      <span class="rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold text-emerald-700"><%= keyword[:name] %> (<%= keyword[:count] %>)</span>
                    <% end %>
                  </div>
                <% end %>
                <% if category[:negatives].present? %>
                  <p class="mt-4 text-xs font-semibold uppercase tracking-wide text-rose-500">Needs attention</p>
                  <div class="mt-2 flex flex-wrap gap-2">
                      <% category[:negatives].first(3).each do |keyword| %>
                      <span class="rounded-full bg-rose-100 px-3 py-1 text-xs font-semibold text-rose-700"><%= keyword[:name] %> (<%= keyword[:count] %>)</span>
                    <% end %>
                  </div>
                  <% end %>
                <% else %>
                  <p class="mt-4 text-xs text-slate-500"><%= link_to 'Unlock full Tablr access', '/users/sign_up', class: 'text-indigo-500 underline decoration-indigo-200 hover:decoration-indigo-400' %> to surface the exact category themes fueling these mentions.</p>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if dish_keywords.present? %>
        <div class="mt-10">
          <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500">Signature Dishes to Spotlight</h3>
          <div class="mt-4 flex flex-wrap gap-3">
            <% dish_keywords.first(6).each_with_index do |dish, index| %>
              <% dish_name = dish[:name].to_s %>
              <% if index < 3 && dish_name.present? %>
                <span class="rounded-full bg-indigo-100 px-4 py-2 text-sm font-semibold text-indigo-700"><%= dish_name %> (<%= dish[:count] %>)</span>
              <% else %>
                <%= link_to "Unlock (#{dish[:count]})", '/users/sign_up', class: 'rounded-full border border-indigo-200 bg-white px-4 py-2 text-sm font-semibold text-indigo-400 hover:text-indigo-600 hover:border-indigo-300' %>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </section>

  <section class="mx-auto mt-16 max-w-5xl px-6 pb-24">
    <div class="rounded-3xl bg-gradient-to-br from-indigo-500 via-indigo-400 to-sky-400 p-10 text-white shadow-2xl shadow-indigo-200/60">
      <div class="grid gap-8 lg:grid-cols-2">
        <div>
          <h2 class="text-3xl font-semibold">Unlock the Full Tablr Dashboard</h2>
          <p class="mt-4 text-base text-indigo-50">
            This is just a snapshot of your restaurant’s online reputation. Unlock the full 100-review analysis — including trend tracking and competitor benchmarks — by signing up on Tablr.io.
          </p>
          <p class="mt-4 text-sm text-indigo-50/90">You can also share this report with your team via email or public link to keep everyone focused on the guest experience.</p>
        </div>
        <div class="flex flex-col justify-between gap-6 rounded-2xl bg-white/15 p-8 backdrop-blur">
          <p class="text-lg font-medium text-white">Ready to see the live dashboard for <%= @place.name %>?</p>
          <div class="space-y-3">
            <%= link_to 'Sign Up on Tablr.io', new_demo_request_path, class: 'block rounded-full bg-white px-5 py-3 text-center text-sm font-semibold uppercase tracking-wide text-indigo-700 shadow-lg shadow-white/30 transition hover:-translate-y-0.5 hover:bg-slate-100', data: { turbo: false } %>
            <%= button_tag 'Copy Shareable Link', type: 'button', class: 'w-full rounded-full border border-white/60 px-5 py-3 text-center text-sm font-semibold uppercase tracking-wide text-white transition hover:bg-white/10', onclick: "navigator.clipboard.writeText('#{share_url_js}'); this.innerText='Link Copied!'; setTimeout(() => { this.innerText = 'Copy Shareable Link'; }, 2000);" %>
          </div>
          <p class="text-xs uppercase tracking-[0.3em] text-indigo-100/70">Tablr.io · Restaurant Intelligence That Sells</p>
        </div>
      </div>
    </div>
  </section>
</main>